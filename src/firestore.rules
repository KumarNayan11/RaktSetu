
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Blood Requests: Public can read, anyone can write.
    // In a real production app, you'd restrict writes to authenticated users (e.g., hospital staff)
    match /bloodRequests/{requestId} {
      allow read: if true;
      allow write: if true; 
    }

    // This query requires a composite index on hospitalId and createdAt.
    // And another on bloodGroup and createdAt.
    // And another on both hospitalId, bloodGroup and createdAt.
    // By defining it in the rules, we can have it created automatically.
    // See https://firebase.google.com/docs/firestore/query-data/indexing
    match /bloodRequests/{requestId} {
      // Allowlist a query for a specific hospital, ordered by creation time
      allow list: if query.where('hospitalId', '==', request.query.hospitalId)
                  && query.orderBy('createdAt', 'desc');

      // Allowlist a query for a specific blood group, ordered by creation time
      allow list: if query.where('bloodGroup', '==', request.query.bloodGroup)
                  && query.orderBy('createdAt', 'desc');
                  
      // Allowlist a query for a specific hospital and blood group, ordered by creation time
      allow list: if query.where('hospitalId', '==', request.query.hospitalId)
                  && query.where('bloodGroup', '==', request.query.bloodGroup)
                  && query.orderBy('createdAt', 'desc');
    }

    // Hospitals: Public can read, anyone can write.
    // In a real production app, you'd restrict writes to authenticated admins.
    match /hospitals/{hospitalId} {
      allow read: if true;
      allow write: if true;
    }
     // Users: Only authenticated users can read their own document. Admins can write.
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if true; // In prod, restrict to admins
    }
  }
}
